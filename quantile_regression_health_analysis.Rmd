---
title: "Quantile Regression for Population Health Analysis"
author: "Arash Ardalan"
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)
```

## 1. Overview

This notebook demonstrates a clean, reproducible approach to analysing health-related outcomes using **quantile regression**.
Unlike mean regression, quantile regression allows us to examine how associations differ across the **entire distribution** of an outcome (e.g. BMI), which is particularly important in population health research.

### Data disclaimer

The dataset used in this analysis is an **anonymised subset (n = 1000)** derived from a larger adolescent health study.
Only a limited set of anthropometric, demographic, and family-level variables were retained.
All identifiers were removed, and the data is used solely for demonstrating analytical workflows.

---

## 2. Libraries

```{r}
library(tidyverse)
library(ggplot2)
library(quantreg)
library(broom)
```


---

## 3. Load data

```{r}
df <- read.csv("...\\health_sample_data.csv")

glimpse(df)
summary(df)
```


### Basic cleaning and typing

```{r}
df <- df %>%
  mutate(
    Gender = factor(Gender),
    city = factor(city),
    activity = factor(activity),
    parent_obese_father = factor(parent_obese_father),
    parent_obese_mother = factor(parent_obese_mother)
  ) %>%
  filter(
    is.finite(bmi),
    is.finite(body_fat),
    is.finite(age)
  )
```


### Missingness check

```{r}
miss_rate <- sapply(df, function(x) mean(is.na(x)))
miss_rate
```


---

## 4. Exploratory Data Analysis (EDA)

### 4.1 BMI distribution

```{r}
ggplot(df, aes(x = bmi)) +
  geom_histogram(bins = 30) +
  labs(title = "BMI distribution", x = "BMI", y = "Count")
```


### 4.2 BMI distribution by gender

```{r}
ggplot(df, aes(x = bmi, fill = Gender)) +
  geom_histogram(bins = 30, alpha = 0.6, position = "identity") +
  labs(title = "BMI distribution by gender", x = "BMI", y = "Count")
```


---

### 4.3 Summary statistics by gender

```{r}
df %>%
group_by(Gender) %>%
summarise(
n = n(),
bmi_mean = mean(bmi, na.rm = TRUE),
bmi_sd = sd(bmi, na.rm = TRUE),
bf_mean = mean(body_fat, na.rm = TRUE),
bf_sd = sd(body_fat, na.rm = TRUE),
age_mean = mean(age, na.rm = TRUE),
.groups = "drop"
)
```

---

### 4.4 Relationship plots

```{r}



ggplot(df, aes(x = body_fat, y = bmi)) +
geom_point(alpha = 0.4) +
geom_smooth(method = "lm", se = TRUE) +
labs(
title = "BMI vs Body Fat",
x = "Body fat",
y = "BMI"
)
```


```{r}



ggplot(df, aes(x = muscle_thickness, y = bmi, colour = Gender)) +
geom_point(alpha = 0.4) +
geom_smooth(method = "lm", se = TRUE) +
labs(
title = "BMI vs Muscle Thickness (by gender)",
x = "Muscle thickness",
y = "BMI"
)
```
---

We focus on a small, interpretable set of predictors to emphasise clarity and practical insight rather than model complexity.


## 5. Quantile Regression

### 5.1 Model specification

```{r}
taus <- c(0.1, 0.25, 0.5, 0.75, 0.9)

formula_qr <- bmi ~ body_fat + muscle_thickness + waist_hip_avg +
  parent_obese_father + parent_obese_mother +
  age + Gender + city + activity
```

---

### 5.2 Fit quantile regression models

```{r}
qr_fit <- rq(formula_qr, tau = taus, data = df)
summary(qr_fit, se = "nid")
```


---

### 5.3 Median regression (tau = 0.5)

```{r}
qr_med <- rq(formula_qr, tau = 0.5, data = df)
summary(qr_med, se = "nid")
```

---

## 6. Coefficient trends across quantiles

```{r}


coef_df <- tidy(qr_fit) %>%
filter(term != "(Intercept)")

ggplot(coef_df, aes(x = tau, y = estimate, group = term, colour = term)) +
geom_line() +
geom_point() +
labs(
title = "Quantile regression coefficients across BMI distribution",
x = "Quantile (tau)",
y = "Coefficient estimate"
)


```

---

### Focused view: key predictors

```{r}

key_terms <- c(
"body_fat",
"muscle_thickness",
"waist_hip_avg",
"parent_obese_fatherYes",
"parent_obese_motherYes"
)

coef_df_key <- coef_df %>%
filter(term %in% key_terms)
```


```{r}
qr_med <- rq(formula_qr, tau = 0.5, data = df)
summary(qr_med, se = "nid")
```


```{r}
coef_df <- tidy(qr_fit) %>%
  filter(term != "(Intercept)")
```
 key_terms)

```{r}
ggplot(coef_df, aes(x = tau, y = estimate, group = term, color = term)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Quantile regression coefficients across BMI distribution",
    x = "Quantile (tau)",
    y = "Coefficient estimate"
  )
```


---

## 7. Interpretation

```{r}

coef_df_key %>%
 select(tau, term, estimate) %>%
 pivot_wider(names_from = tau, values_from = estimate)

```

**Interpretation guidance:**

* Increasing coefficients at higher quantiles indicate stronger associations among higher-BMI individuals.
* Differences across quantiles highlight heterogeneity that is not captured by mean regression.
* All results represent **associations**, not causal effects.

---

## 8.  Logistic regression

```{r}
df <- df %>%
  mutate(high_bmi = factor(ifelse(bmi >= 25, "Yes", "No")))

glm_fit <- glm(
  high_bmi ~ body_fat + muscle_thickness + waist_hip_avg +
    parent_obese_father + parent_obese_mother +
    age + Gender + city + activity,
  family = binomial(link = "logit"),
  data = df
)

summary(glm_fit)
```


---

## 9. Limitations and good practice

* Observational data do not support causal inference
* Potential unmeasured confounding and measurement error
* Results shown for methodological demonstration purposes

---

## 10. Conclusion

This project demonstrates an end-to-end, reproducible workflow for population health analysis using **quantile regression**, combining sound statistical practice with clear communication and ethical data handling.


